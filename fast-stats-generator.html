<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BER Fast Stats Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #00A6CE;
            --dark-blue: #1A3A5C;
            --light-row: #F5F9FC;
            --border: #E0E0E0;
            --text: #333333;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', Arial, sans-serif;
            background: #f0f4f8;
            color: var(--text);
        }

        /* === APP LAYOUT === */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 320px;
            background: #ffffff;
            padding: 24px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .main-content {
            flex: 1;
            margin-left: 320px;
            padding: 24px;
            display: flex;
            justify-content: center;
        }

        /* === SIDEBAR STYLES === */
        .sidebar h1 {
            font-size: 18px;
            color: var(--dark-blue);
            margin-bottom: 4px;
        }

        .sidebar .subtitle {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: #f8fafc;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .dropzone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
            background: #f8fafc;
        }

        .dropzone:hover {
            border-color: var(--primary);
            background: #f0fdfa;
        }

        .dropzone .icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .dropzone .text {
            font-size: 12px;
            color: #64748b;
        }

        .file-status {
            margin-bottom: 16px;
        }

        .file-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #f1f5f9;
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .file-row .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .file-row .dot.ok {
            background: #22c55e;
        }

        .file-row .dot.pending {
            background: #f59e0b;
        }

        .file-row .name {
            flex: 1;
            color: #475569;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #0284c7);
            color: white;
        }

        .btn-secondary {
            background: var(--dark-blue);
            color: white;
        }

        /* === REPORT PREVIEW === */
        .preview-container {
            background: #e2e8f0;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.05);
            /* nicer inset look */
            border-radius: 8px;
            overflow: auto;
            /* Allow horizontal scroll for landscape */
            padding: 20px;
        }

        .report {
            width: fit-content;
            margin: 0 auto;
            min-height: auto;
            padding: 0;
            background: transparent;
        }

        /* New class creates the "Paper" look for Fast Stats */
        .fast-stats-layout {
            width: 8.5in;
            min-height: 11in;
            padding: 0.5in 0.6in;
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin: 0 auto 30px auto;
            font-size: 10pt;
        }

        /* === REPORT HEADER === */
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .report-header .left h1 {
            font-size: 18pt;
            font-weight: 800;
            color: #000;
            margin-bottom: 2px;
            white-space: nowrap;
        }

        .report-header .left .provided-by {
            font-size: 8pt;
            font-style: italic;
            color: #555;
        }

        .report-header .logo {
            width: 160px;
            text-align: right;
        }

        .report-header .logo img {
            max-width: 100%;
            height: auto;
        }

        .region-title {
            font-size: 32pt;
            font-weight: 800;
            color: var(--primary);
            margin: 10px 0 0 0;
        }

        .region-subtitle {
            font-size: 14pt;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 16px;
        }

        /* === DATA TABLES === */
        .section-title {
            font-size: 14pt;
            font-weight: 700;
            color: #000;
            margin: 20px 0 8px 0;
        }

        .data-table-container {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .data-table {
            border-collapse: collapse;
            font-size: 9pt;
        }

        .data-table.monthly {
            flex: 0 0 auto;
        }

        .data-table.ytd {
            flex: 0 0 auto;
        }

        .data-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            padding: 8px 10px;
            text-align: center;
            border: 1px solid var(--primary);
        }

        .data-table th.metric-header {
            text-align: left;
            min-width: 160px;
        }

        .data-table th.year-col {
            min-width: 85px;
        }

        .data-table th.change-col {
            min-width: 70px;
        }

        .data-table td {
            padding: 6px 10px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .data-table td.metric-name {
            text-align: left;
            font-weight: 500;
            background: white;
        }

        .data-table tr:nth-child(even) td {
            background: var(--light-row);
        }

        .data-table tr:nth-child(even) td.metric-name {
            background: var(--light-row);
        }

        .data-table td.value-bold {
            font-weight: 700;
        }

        .data-table td.empty-cell {
            background: #8BA9C5 !important;
        }

        /* Blank header for monthly columns (no title) */
        .data-table th.blank-header {
            background: white;
            border: none;
        }

        /* YTD main header - inherits primary cyan from th */
        .data-table th.ytd-main-header {
            font-weight: 600;
        }

        /* Month header for monthly columns - inherits primary cyan from th */
        .data-table th.month-header {
            font-weight: 600;
        }

        /* === FOOTER === */
        .report-footer {
            margin-top: 24px;
            font-size: 8pt;
            color: #555;
            font-style: italic;
        }

        .report-footer .disclaimer {
            margin-bottom: 12px;
        }

        .report-footer .attribution {
            text-align: center;
        }

        /* === PRINT STYLES === */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body {
                background: white;
            }

            .sidebar {
                display: none !important;
            }

            .main-content {
                margin-left: 0;
                padding: 0;
            }

            .preview-container {
                box-shadow: none;
                border-radius: 0;
            }

            .report {
                width: 100%;
                max-width: 7.5in;
                padding: 0.25in 0.3in;
            }

            .data-table-container {
                max-width: 100%;
                overflow: visible;
            }

            .data-table {
                width: 100%;
                max-width: 100%;
                font-size: 7pt;
                table-layout: auto;
            }

            .data-table th,
            .data-table td {
                padding: 3px 4px;
                white-space: nowrap;
            }

            .data-table td.metric-name {
                white-space: normal;
                font-size: 7pt;
            }

            .data-table th.year-col {
                min-width: unset;
            }

            .data-table th.change-col {
                min-width: unset;
            }

            .data-table th.metric-header {
                min-width: unset;
                white-space: normal;
            }

            .report-header .left h1 {
                font-size: 16pt;
            }

            .section-title {
                font-size: 12pt;
            }

            .region-title {
                font-size: 20pt;
            }
        }

        /* === MONTHLY INDICATORS REPORT CSS === */
        .indicator-page {
            width: 100%;
            max-width: 11in;
            /* Landscape width */
            min-height: 8.5in;
            /* Landscape height */
            margin: 0 auto 30px auto;
            background: white;
            padding: 0.5in;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            page-break-after: always;
        }

        @media print {
            @page {
                size: portrait;
                margin: 0.25in;
            }

            @page landscape {
                size: landscape;
                margin: 0.25in;
            }

            .indicator-page {
                page: landscape;
                box-shadow: none;
                margin: 0;
                width: 11in !important;
                height: 8.5in !important;
                max-width: none;
                /* critical fixes for print layout */
                overflow: hidden;
                page-break-after: always;
                break-after: page;
                break-inside: avoid;
            }

            .report-page {
                page: auto;
                /* Default portrait */
            }

            .no-print {
                display: none !important;
            }
        }

        .cover-header {
            border-bottom: 2px solid #ccc;
            padding-bottom: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cover-title {
            font-size: 32px;
            font-weight: 700;
        }

        .cover-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .quick-facts {
            margin-bottom: 40px;
        }

        .quick-facts-header {
            color: #00A6CE;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .fact-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .fact-item {
            flex: 1;
        }

        .fact-value {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .fact-label {
            font-size: 12px;
            color: #555;
            line-height: 1.3;
        }

        .toc-list {
            list-style: none;
            padding: 0;
        }

        .toc-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .toc-page {
            color: #00A6CE;
            font-weight: 600;
        }

        .summary-text {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
        }

        /* Logo placeholder styling */
        .logo-placeholder {
            background: linear-gradient(135deg, #00A6CE, #0284c7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 10pt;
            font-weight: 700;
            text-align: center;
            line-height: 1.3;
        }

        .logo-placeholder .top {
            font-size: 8pt;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .logo-placeholder .main {
            font-size: 11pt;
            letter-spacing: 0.5px;
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h1>üìä Fast Stats Generator</h1>
            <p class="subtitle">Create Local Market Update reports</p>

            <div class="form-row">
                <div class="form-group">
                    <label>Month</label>
                    <select id="month" onchange="reprocessAllData()">
                        <option>January</option>
                        <option>February</option>
                        <option>March</option>
                        <option>April</option>
                        <option>May</option>
                        <option>June</option>
                        <option>July</option>
                        <option>August</option>
                        <option>September</option>
                        <option>October</option>
                        <option selected>November</option>
                        <option>December</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Year</label>
                    <input type="number" id="year" value="2025" onchange="reprocessAllData()">
                </div>
            </div>

            <div class="form-group">
                <label>Region Name</label>
                <input type="text" id="regionName" value="Southwest Florida" onchange="updateReport()">
            </div>

            <div class="form-group">
                <label>Counties</label>
                <input type="text" id="counties" value="Lee, Collier, Hendry Counties" onchange="updateReport()">
            </div>

            <div class="dropzone" id="dropzone">
                <div class="icon">üìÅ</div>
                <div class="text">Drop <strong>Excel files</strong> here<br>or click to browse</div>
                <input type="file" id="fileInput" multiple accept=".xlsx,.xls,.csv" style="display:none">
            </div>

            <!-- File Status -->
            <div id="fileStatus" class="file-status"></div>

            <!-- Unassigned Files Container -->
            <div id="unassigned-files"
                style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; display: none;">
                <!-- Dropdowns will appear here -->
            </div>

            <!-- Report Type Selection -->
            <div class="control-group">
                <label>Report Type</label>
                <div class="report-type-toggle" style="display: flex; gap: 10px; margin-top: 5px; margin-bottom: 20px;">
                    <button id="btn-show-faststats" class="action-btn active"
                        style="flex: 1; font-size: 12px; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;"
                        onclick="switchReport('faststats')">Fast Stats</button>
                    <button id="btn-show-indicators" class="action-btn secondary"
                        style="flex: 1; font-size: 12px; padding: 8px; background: #e2e8f0; color: #64748b; border: none; border-radius: 4px; cursor: pointer;"
                        onclick="switchReport('indicators')">Monthly Indicators</button>
                </div>
            </div>

            <!-- Monthly Indicators Controls (Hidden by default) -->
            <div id="indicators-controls" style="display: none; margin-bottom: 20px;">
                <div class="control-group">
                    <label>Cover Summary Text</label>
                    <textarea id="cover-summary" rows="6"
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 13px; resize: vertical;"
                        placeholder="Enter the monthly market commentary here..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="generateMonthlyIndicators()"
                    style="width: 100%; margin-top: 10px; background: #0ea5e9;">üìä Generate Report</button>
                <button class="btn btn-primary" onclick="window.print()" style="margin-top: 20px;">üñ®Ô∏è Print / Save as
                    PDF</button>
                <button class="btn btn-secondary" onclick="downloadPDF('indicators', this)"
                    style="margin-top: 10px; background: #475569;">‚¨áÔ∏è Download PDF File</button>
            </div>

            <!-- Fast Stats Controls -->
            <div id="fast-stats-controls">
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button>
                <button class="btn btn-secondary" onclick="downloadPDF('faststats', this)"
                    style="margin-top: 10px; background: #475569;">‚¨áÔ∏è Download PDF File</button>
            </div>

            <button class="btn btn-secondary" onclick="resetData()">üîÑ Reset to Defaults</button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="preview-container">
                <div class="report" id="report">
                    <div id="fast-stats-content" class="report-page fast-stats-layout">
                        <!-- Header -->
                        <div class="report-header">
                            <div class="left">
                                <h1>Local Market Update ‚Äì <span id="headerMonth">November</span> <span
                                        id="headerYear">2025</span></h1>
                                <div class="provided-by">A Research Tool Provided by Bonita Springs-Estero Realtors¬Æ
                                </div>
                            </div>
                            <div class="logo">
                                <img src="https://bonitaesterorealtors.com/wp-content/uploads/2025/12/Ber-logo-2026-scaled.png"
                                    alt="Bonita Springs-Estero REALTORS¬Æ" style="width: 180px; height: auto;">
                            </div>
                        </div>

                        <div class="region-title" id="regionTitle">Southwest Florida</div>
                        <div class="region-subtitle" id="regionSubtitle">(Lee, Collier, Hendry Counties)</div>

                        <!-- Single Family Section -->
                        <div class="section-title">Single Family</div>
                        <div class="data-table-container">
                            <table class="data-table monthly">
                                <thead>
                                    <tr>
                                        <th class="metric-header" rowspan="2">Key Metrics</th>
                                        <th colspan="3" class="month-header" id="sfMonthHeader">November</th>
                                        <th colspan="3" class="ytd-main-header">Year To Date</th>
                                    </tr>
                                    <tr>
                                        <th class="year-col" id="sfMonthPrevYear">2024</th>
                                        <th class="year-col" id="sfMonthCurrYear">2025</th>
                                        <th class="change-col">% Change</th>
                                        <th class="year-col" id="sfYtdPrevYear">Thru 11-2024</th>
                                        <th class="year-col" id="sfYtdCurrYear">Thru 11-2025</th>
                                        <th class="change-col">% Change</th>
                                    </tr>
                                </thead>
                                <tbody id="sfMonthlyBody">
                                    <!-- Generated by JS -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Condo Section -->
                        <div class="section-title">Condo</div>
                        <div class="data-table-container">
                            <table class="data-table monthly">
                                <thead>
                                    <tr>
                                        <th class="metric-header" rowspan="2">Key Metrics</th>
                                        <th colspan="3" class="month-header" id="condoMonthHeader">November</th>
                                        <th colspan="3" class="ytd-main-header">Year To Date</th>
                                    </tr>
                                    <tr>
                                        <th class="year-col" id="condoMonthPrevYear">2024</th>
                                        <th class="year-col" id="condoMonthCurrYear">2025</th>
                                        <th class="change-col">% Change</th>
                                        <th class="year-col" id="condoYtdPrevYear">Thru 11-2024</th>
                                        <th class="year-col" id="condoYtdCurrYear">Thru 11-2025</th>
                                        <th class="change-col">% Change</th>
                                    </tr>
                                </thead>
                                <tbody id="condoMonthlyBody">
                                    <!-- Generated by JS -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Footer -->
                        <!-- Land Section -->


                        <div class="report-footer">
                            <div class="disclaimer">Percent changes are calculated using rounded figures and can
                                sometimes
                                look extreme due to small sample size.</div>
                            <div class="attribution">Current as of <span id="currentDate">December 9th, 2025</span>. All
                                data from Bonita
                                Springs-Estero Board of Realtors¬Æ MLS | Data gathered from Domus Analytics</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Indicators Report Controls (Initially Hidden) -->
            <div id="monthly-indicators-container" class="report monthly-indicators-report" style="display: none;">
                <div class="indicators-placeholder" style="text-align: center; padding: 50px; color: #666;">
                    <h2>Monthly Indicators Report</h2>
                    <p>Select "Monthly Indicators" in the sidebar and click "Generate Report" to view.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Metric definitions
        const metrics = [
            { key: 'newListings', label: 'New Listings', format: 'number', hasYtd: true },
            { key: 'pendingSales', label: 'Pending Sales', format: 'number', hasYtd: true },
            { key: 'closedSales', label: 'Closed Sales', format: 'number', hasYtd: true },
            { key: 'daysOnMarket', label: 'Days on Market (Median)', format: 'number', hasYtd: true },
            { key: 'medianPrice', label: 'Median Sales Price', format: 'currency', hasYtd: true },
            { key: 'soldVolume', label: 'Sold Dollar Volume', format: 'currency', hasYtd: true },
            { key: 'listPriceReceived', label: 'Percent of List Price Received', format: 'percent', hasYtd: true },
            { key: 'inventory', label: 'Inventory of Homes for Sale', format: 'number', hasYtd: false },
            { key: 'monthsSupply', label: 'Months Supply of Inventory', format: 'decimal', hasYtd: false }
        ];

        // Default data (from the PDF)
        let data = {
            singleFamily: {
                monthly: {
                    prev: { newListings: 3301, pendingSales: 1520, closedSales: 1188, daysOnMarket: 53, medianPrice: 432495, soldVolume: 875151613, listPriceReceived: 95.90, inventory: 11373, monthsSupply: 9.6 },
                    curr: { newListings: 2821, pendingSales: 2050, closedSales: 1289, daysOnMarket: 62, medianPrice: 415000, soldVolume: 893290944, listPriceReceived: 95.70, inventory: 11332, monthsSupply: 8.8 }
                },
                ytd: {
                    prev: { newListings: 31738, pendingSales: 15241, closedSales: 17381, daysOnMarket: 48, medianPrice: 450000, soldVolume: 12879155814, listPriceReceived: 96.30 },
                    curr: { newListings: 33284, pendingSales: 15929, closedSales: 17870, daysOnMarket: 58, medianPrice: 430000, soldVolume: 13495798665, listPriceReceived: 95.70 }
                }
            },
            condo: {
                monthly: {
                    prev: { newListings: 1998, pendingSales: 785, closedSales: 436, daysOnMarket: 61, medianPrice: 365000, soldVolume: 245022228.00, listPriceReceived: 94.40, inventory: 7003, monthsSupply: 16.1 },
                    curr: { newListings: 1728, pendingSales: 1082, closedSales: 547, daysOnMarket: 65, medianPrice: 340000, soldVolume: 289782068.00, listPriceReceived: 94.30, inventory: 7459, monthsSupply: 13.6 }
                },
                ytd: {
                    prev: { newListings: 16991, pendingSales: 7046, closedSales: 8146, daysOnMarket: 54, medianPrice: 403018, soldVolume: 4976987803, listPriceReceived: 95.40 },
                    curr: { newListings: 17622, pendingSales: 7036, closedSales: 7962, daysOnMarket: 74, medianPrice: 360000, soldVolume: 4427891626, listPriceReceived: 94.10 }
                }
            }
        };

        // Format value based on type
        function formatValue(value, format) {
            if (value === null || value === undefined) return '-';

            switch (format) {
                case 'currency':
                    if (value >= 1000000000) {
                        return '$' + (value / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
                    } else if (value >= 1000000) {
                        return '$' + value.toLocaleString('en-US', { maximumFractionDigits: 0 });
                    }
                    return '$' + value.toLocaleString('en-US', { maximumFractionDigits: 0 });
                case 'percent':
                    return value.toFixed(2) + '%';
                case 'decimal':
                    return value.toFixed(1);
                default:
                    return value.toLocaleString('en-US');
            }
        }

        // Calculate percent change
        function calcChange(prev, curr) {
            if (!prev || prev === 0) return '-';
            const change = ((curr - prev) / prev) * 100;
            const sign = change > 0 ? '' : '';
            return change.toFixed(2) + '%';
        }

        // Render unified table body (all 7 columns: metric + monthly + ytd)
        function renderTableBody(containerId, propType) {
            const tbody = document.getElementById(containerId);
            const monthName = document.getElementById('month').value;
            const year = parseInt(document.getElementById('year').value);
            const prevYear = year - 1;
            const monthIdx = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"].indexOf(monthName) + 1;

            let html = '';

            metrics.forEach(metric => {
                // Monthly Values
                const monthlyPrev = getMetricValue(propType, metric.key, monthIdx, prevYear);
                const monthlyCurr = getMetricValue(propType, metric.key, monthIdx, year);

                // YTD Values (Calculate on the fly)
                let ytdPrev = 0, ytdCurr = 0;
                let ytdPrevCount = 0, ytdCurrCount = 0;

                // Simple YTD Loop
                if (metric.hasYtd) {
                    for (let m = 1; m <= monthIdx; m++) {
                        const vPrev = getMetricValue(propType, metric.key, m, prevYear);
                        const vCurr = getMetricValue(propType, metric.key, m, year);

                        // For Sum metrics
                        if (metric.key !== 'daysOnMarket' && metric.key !== 'medianPrice' && metric.key !== 'listPriceReceived') {
                            ytdPrev += vPrev;
                            ytdCurr += vCurr;
                        } else {
                            // For Avg metrics, we need to be careful. 
                            // Simple average of months isn't perfectly weighted but close enough for this generator's purpose 
                            // unless we want to do full weighted calc. 
                            // Existing logic did simple average in processMetricData.
                            if (vPrev > 0) { ytdPrev += vPrev; ytdPrevCount++; }
                            if (vCurr > 0) { ytdCurr += vCurr; ytdCurrCount++; }
                        }
                    }
                    if (metric.key === 'daysOnMarket' || metric.key === 'medianPrice' || metric.key === 'listPriceReceived') {
                        ytdPrev = ytdPrevCount ? ytdPrev / ytdPrevCount : 0;
                        ytdCurr = ytdCurrCount ? ytdCurr / ytdCurrCount : 0;
                    }
                }

                const hasYtd = metric.hasYtd;

                html += '<tr>';
                // Metric name
                html += '<td class="metric-name">' + metric.label + '</td>';
                // Monthly columns
                html += '<td>' + formatValue(monthlyPrev, metric.format) + '</td>';
                html += '<td class="value-bold">' + formatValue(monthlyCurr, metric.format) + '</td>';
                html += '<td>' + calcChange(monthlyPrev, monthlyCurr) + '</td>';
                // YTD columns
                if (hasYtd) {
                    html += '<td>' + formatValue(ytdPrev, metric.format) + '</td>';
                    html += '<td class="value-bold">' + formatValue(ytdCurr, metric.format) + '</td>';
                    html += '<td>' + calcChange(ytdPrev, ytdCurr) + '</td>';
                } else {
                    html += '<td class="empty-cell"></td>';
                    html += '<td class="empty-cell"></td>';
                    html += '<td class="empty-cell"></td>';
                }
                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        // Update report display
        function updateReport() {
            const month = document.getElementById('month').value;
            const year = parseInt(document.getElementById('year').value);
            const prevYear = year - 1;
            const regionName = document.getElementById('regionName').value;
            const counties = document.getElementById('counties').value;

            // Get month number
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const monthNum = monthNames.indexOf(month) + 1;
            const monthNumStr = monthNum.toString().padStart(2, '0');

            // Update header
            document.getElementById('headerMonth').textContent = month;
            document.getElementById('headerYear').textContent = year;
            document.getElementById('regionTitle').textContent = regionName;
            document.getElementById('regionSubtitle').textContent = '(' + counties + ')';

            // Update month headers in tables
            document.getElementById('sfMonthHeader').textContent = month;
            document.getElementById('condoMonthHeader').textContent = month;

            // Update year headers for Single Family
            document.getElementById('sfMonthPrevYear').textContent = prevYear;
            document.getElementById('sfMonthCurrYear').textContent = year;
            document.getElementById('sfYtdPrevYear').textContent = 'Thru ' + monthNumStr + '-' + prevYear;
            document.getElementById('sfYtdCurrYear').textContent = 'Thru ' + monthNumStr + '-' + year;

            // Update year headers for Condo
            document.getElementById('condoMonthPrevYear').textContent = prevYear;
            document.getElementById('condoMonthCurrYear').textContent = year;
            document.getElementById('condoYtdPrevYear').textContent = 'Thru ' + monthNumStr + '-' + prevYear;
            document.getElementById('condoYtdCurrYear').textContent = 'Thru ' + monthNumStr + '-' + year;

            // Render tables (unified 7-column format)
            renderTableBody('sfMonthlyBody', 'singleFamily');
            renderTableBody('condoMonthlyBody', 'condo');
        }

        // Reset to default data
        function resetData() {
            location.reload();
        }

        // File handling
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');

        dropzone.addEventListener('click', () => fileInput.click());
        dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.style.borderColor = '#00A6CE'; });
        dropzone.addEventListener('dragleave', () => { dropzone.style.borderColor = '#cbd5e1'; });
        dropzone.addEventListener('drop', e => {
            e.preventDefault();
            dropzone.style.borderColor = '#cbd5e1';
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', e => handleFiles(e.target.files));

        // Metric to file mapping with column indices
        const metricConfig = {
            'newListings': { pattern: /new.?listing/i, col: 7 },
            'pendingSales': { pattern: /pending.?sale/i, col: 7 },
            'closedSales': { pattern: /closed.?sale/i, col: 7 },
            'daysOnMarket': { pattern: /days.?on.?market/i, col: 6 },
            'medianPrice': { pattern: /median.?sales?.?price/i, col: 3 },
            'soldVolume': { pattern: /sold.?dollar.?volume/i, col: 5 },
            'listPriceReceived': { pattern: /percent.?of.?list.?price/i, col: 8 },
            'monthsSupply': { pattern: /months?.?supply/i, col: 10 },
            'inventory': { pattern: /^(?!.*supply).*inventory|homes?.?for.?sale/i, col: 7 }
        };

        // Initialize metric storage - now keyed by METRIC KEY
        // rawRowsData structure: { 'closedSales': [rows], 'inventory': [rows], ... }
        const rawRowsData = {};

        // Track unassigned files
        let pendingFiles = [];

        function detectMetricType(filename) {
            const name = filename.toLowerCase();
            for (const [key, cfg] of Object.entries(metricConfig)) {
                if (cfg.pattern.test(name)) return key;
            }
            return null;
        }

        // Handle uploaded files
        async function handleFiles(files) {
            Array.from(files).forEach(file => {
                let metricKey = detectMetricType(file.name);

                // Read file first
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, defval: '' });

                        if (metricKey) {
                            // Auto-detected
                            assignData(metricKey, rows);
                        } else {
                            // Add to pending for manual assignment
                            pendingFiles.push({ name: file.name, rows: rows });
                            renderUnassignedFiles();
                        }

                    } catch (error) {
                        console.error('Error parsing file:', error);
                        alert('Error parsing ' + file.name);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function assignData(metricKey, rows) {
            rawRowsData[metricKey] = rows;
            updateFileStatus();
            reprocessAllData();
        }

        function renderUnassignedFiles() {
            const container = document.getElementById('unassigned-files');
            if (pendingFiles.length === 0) {
                container.innerHTML = '';
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            let html = '<div style="font-size:12px; font-weight:bold; margin-bottom:5px; color:#c02aa8;">Unidentified Files:</div>';

            pendingFiles.forEach((file, index) => {
                html += `<div style="margin-bottom: 8px; background: #fff5f5; padding: 5px; border-radius: 4px;">
                    <div style="font-size:11px; margin-bottom:3px; overflow:hidden; text-overflow:ellipsis;">${file.name}</div>
                    <select onchange="manualAssign(${index}, this.value)" style="width:100%; font-size:11px;">
                        <option value="">-- Select Data Type --</option>
                        ${metrics.map(m => `<option value="${m.key}">${m.label}</option>`).join('')}
                    </select>
                </div>`;
            });
            container.innerHTML = html;
        }

        function manualAssign(index, metricKey) {
            if (!metricKey) return;
            const fileData = pendingFiles[index];
            assignData(metricKey, fileData.rows);

            // Remove from pending
            pendingFiles.splice(index, 1);
            renderUnassignedFiles();
        }

        function updateFileStatus() {
            const statusDiv = document.getElementById('fileStatus');
            let html = '<div style="font-weight:bold; font-size:12px; margin-bottom:5px;">Data Status</div>';
            metrics.forEach(m => {
                const loaded = rawRowsData[m.key] !== undefined;
                html += '<div class="file-row">';
                html += '<div class="dot ' + (loaded ? 'ok' : 'pending') + '"></div>';
                html += '<div class="name">' + m.label + '</div>';
                html += '<div>' + (loaded ? '‚úì' : '-') + '</div>';
                html += '</div>';
            });
            statusDiv.innerHTML = html;
        }

        // Global helper to get metric value (Updated for Multi-File One-Metric-Per-File)
        function getMetricValue(propType, metricKey, month, year) {
            try {
                // Aggregation for 'all' property types
                if (propType === 'all') {
                    const sfVal = getMetricValue('singleFamily', metricKey, month, year);
                    const condoVal = getMetricValue('condo', metricKey, month, year);
                    const landVal = getMetricValue('land', metricKey, month, year);
                    const multiVal = getMetricValue('multiFamily', metricKey, month, year);

                    if (metricKey === 'medianPrice' || metricKey === 'daysOnMarket' || metricKey === 'listPriceReceived') {
                        const sfCount = getMetricValue('singleFamily', 'closedSales', month, year);
                        const condoCount = getMetricValue('condo', 'closedSales', month, year);
                        const landCount = getMetricValue('land', 'closedSales', month, year);
                        const multiCount = getMetricValue('multiFamily', 'closedSales', month, year);
                        const totalCount = sfCount + condoCount + landCount + multiCount;
                        if (totalCount === 0) return 0;
                        return ((sfVal * sfCount) + (condoVal * condoCount) + (landVal * landCount) + (multiVal * multiCount)) / totalCount;
                    } else if (metricKey === 'monthsSupply') {
                        const sfInv = getMetricValue('singleFamily', 'inventory', month, year);
                        const condoInv = getMetricValue('condo', 'inventory', month, year);
                        const landInv = getMetricValue('land', 'inventory', month, year);
                        const multiInv = getMetricValue('multiFamily', 'inventory', month, year);
                        const totalInv = sfInv + condoInv + landInv + multiInv;
                        if (totalInv === 0) return 0;
                        return ((sfVal * sfInv) + (condoVal * condoInv) + (landVal * landInv) + (multiVal * multiInv)) / totalInv;
                    } else {
                        return sfVal + condoVal + landVal + multiVal;
                    }
                }

                // 1. Get correct file rows for this metric
                const rows = rawRowsData[metricKey];
                if (!rows) return 0;

                // DATA FORMAT IS COLUMNAR:
                // Col 0: Date (e.g. "2025-Jan")
                // Col 1: Property Type (e.g. "Single Family Residence")
                // Col X: Value (defined in metricConfig)

                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const targetMon = monthNames[month - 1]; // "Jan"
                const targetDateStr = `${year}-${targetMon}`; // "2025-Jan"

                // Find the row that matches both Date and Property Type
                const matchingRow = rows.find(r => {
                    if (!r[0] || !r[1]) return false;

                    // Check Date (Col 0)
                    // The file uses "YYYY-Mon" e.g. "2018-Jan"
                    const rowDate = r[0].toString();
                    if (rowDate !== targetDateStr) return false;

                    // Check Property Type (Col 1)
                    const rowType = r[1].toString().toLowerCase();
                    if (propType === 'singleFamily') {
                        return rowType.includes('single') || rowType.includes('residential');
                    }
                    if (propType === 'condo') {
                        return rowType.includes('condo') || rowType.includes('townhouse');
                    }
                    if (propType === 'land') {
                        return rowType.includes('land') || rowType.includes('lot');
                    }
                    if (propType === 'multiFamily') {
                        return rowType.includes('multi');
                    }
                    return false;
                });

                if (!matchingRow) return 0;

                // Extract Value from configured column
                const colIdx = metricConfig[metricKey].col;
                let valStr = matchingRow[colIdx];

                if (valStr === undefined || valStr === null) return 0;
                if (typeof valStr === 'string') {
                    valStr = valStr.replace(/[$,%]/g, '');
                }
                return parseFloat(valStr) || 0;

            } catch (e) {
                // console.warn('Error in getMetricValue', propType, metricKey, e);
                return 0;
            }
        }

        // === REPORT SWITCHING LOGIC ===
        function switchReport(type) {
            // Update buttons
            const btnFast = document.getElementById('btn-show-faststats');
            const btnInd = document.getElementById('btn-show-indicators');

            if (type === 'faststats') {
                btnFast.style.background = 'var(--primary)';
                btnFast.style.color = 'white';
                btnInd.style.background = '#e2e8f0';
                btnInd.style.color = '#64748b';

                // Show/Hide controls
                document.getElementById('fast-stats-controls').style.display = 'block';
                document.getElementById('indicators-controls').style.display = 'none';

                // Show/Hide reports
                document.getElementById('report').style.display = 'block';
                document.getElementById('monthly-indicators-container').style.display = 'none';
            } else {
                btnInd.style.background = 'var(--primary)';
                btnInd.style.color = 'white';
                btnFast.style.background = '#e2e8f0';
                btnFast.style.color = '#64748b';

                // Show/Hide controls
                document.getElementById('fast-stats-controls').style.display = 'none';
                document.getElementById('indicators-controls').style.display = 'block';

                // Show/Hide reports
                document.getElementById('report').style.display = 'none';
                document.getElementById('monthly-indicators-container').style.display = 'block';
            }
        }

        function generateMonthlyIndicators() {
            const container = document.getElementById('monthly-indicators-container');
            container.innerHTML = '';

            // Check if essential keys are present
            // We need closedSales and maybe inventory/medianPrice for basic functionality
            // But ideally we check if ALL are present? Or Just warn?
            // Let's just generate what we can.




            // 1. Render Cover Page
            renderCoverPage(container);

            // 2. Single Family Market Overview
            renderOverviewPage(container, 'singleFamily', 2);

            // 3. Condo Market Overview
            renderOverviewPage(container, 'condo', 3);

            // Pages 4-11: Metric Details
            const detailMetrics = [
                { key: 'newListings', page: 4 },
                { key: 'pendingSales', page: 5 },
                { key: 'closedSales', page: 6 },
                { key: 'daysOnMarket', page: 7 },
                { key: 'medianPrice', page: 8 },
                { key: 'listPriceReceived', page: 9 },
                { key: 'inventory', page: 10 },
                { key: 'monthsSupply', page: 11 }
            ];

            detailMetrics.forEach(m => {
                renderMetricPage(container, m.key, m.page);
            });

            // 12. Southwest Florida Overview
            renderOverviewPage(container, 'all', 12);
        }


        // Helper to get month index from name
        function getMonthIndex(name) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return monthNames.indexOf(name) + 1;
        }

        function calculateQuickFacts() {
            try {
                const monthName = document.getElementById('month').value;
                const year = parseInt(document.getElementById('year').value);
                const prevYear = year - 1;
                const monthIdx = getMonthIndex(monthName);

                const formatPct = (val) => {
                    if (isNaN(val) || !isFinite(val)) return 'N/A';
                    const s = val.toFixed(1) + '%';
                    return val > 0 ? '+' + s : s;
                };

                // Helper to get value for ALL properties (SF + Condo)
                const getAllVal = (metricKey, y) => {
                    const val = getMetricValue('all', metricKey, monthIdx, y);
                    return val;
                };

                // 1. Closed Sales
                const currClosed = getAllVal('closedSales', year);
                const prevClosed = getAllVal('closedSales', prevYear);
                const chgClosed = prevClosed ? ((currClosed - prevClosed) / prevClosed) * 100 : 0;

                // 2. Median Price (Weighted)
                const currMedian = getAllVal('medianPrice', year);
                const prevMedian = getAllVal('medianPrice', prevYear);
                const chgMedian = prevMedian ? ((currMedian - prevMedian) / prevMedian) * 100 : 0;

                // 3. Inventory
                const currInv = getAllVal('inventory', year);
                const prevInv = getAllVal('inventory', prevYear);
                const chgInv = prevInv ? ((currInv - prevInv) / prevInv) * 100 : 0;

                return {
                    closedSales: formatPct(chgClosed),
                    medianPrice: formatPct(chgMedian),
                    activeListings: formatPct(chgInv)
                };
            } catch (e) {
                console.error('Error in calculateQuickFacts:', e);
                // Alert only on first error to avoid spam, or just log
                // alert('Quick Facts Error: ' + e.message); 
                return { closedSales: 'N/A', medianPrice: 'N/A', activeListings: 'N/A' };
            }
        }

        function renderCoverPage(container) {
            const monthName = document.getElementById('month').value;
            const year = document.getElementById('year').value;
            const summaryText = document.getElementById('cover-summary').value ||
                `${monthName} showed firm buyer momentum... (Default placeholder text)`;

            // Calculate Quick Facts (Mock data for now, will implement calc logic)
            const facts = calculateQuickFacts();

            const page = document.createElement('div');
            page.className = 'indicator-page';
            page.innerHTML = `
                <div class="cover-header">
                    <div class="cover-title">Monthly Indicators</div>
                    <img src="https://bonitaesterorealtors.com/wp-content/uploads/2025/12/Ber-logo-2026-scaled.png" style="width: 200px;">
                </div>

                <div class="cover-grid">
                    <div class="left-col">
                        <div style="color: #00A6CE; font-size: 24px; margin-bottom: 15px;">${monthName} ${year}</div>
                        <div class="summary-text">${summaryText}</div>
                    </div>
                    
                    <div class="right-col">
                        <div class="quick-facts">
                            <div class="quick-facts-header">Quick Facts</div>
                            
                            <div class="fact-row">
                                <div class="fact-item">
                                    <div class="fact-value">${facts.closedSales}</div>
                                    <div class="fact-label">Change in Closed<br>Sales All Properties</div>
                                </div>
                                <div class="fact-item">
                                    <div class="fact-value">${facts.medianPrice}</div>
                                    <div class="fact-label">Change in Median<br>Sales Price All</div>
                                </div>
                                <div class="fact-item">
                                    <div class="fact-value">${facts.activeListings}</div>
                                    <div class="fact-label">Change in Homes for<br>Sale All Properties</div>
                                </div>
                            </div>
                        </div>

                        <ul class="toc-list">
                            <li class="toc-item"><span>Single Family Market Overview</span> <span class="toc-page">2</span></li>
                            <li class="toc-item"><span>Condo Market Overview</span> <span class="toc-page">3</span></li>
                            <li class="toc-item"><span>New Listings</span> <span class="toc-page">4</span></li>
                            <li class="toc-item"><span>Pending Sales</span> <span class="toc-page">5</span></li>
                            <li class="toc-item"><span>Closed Sales</span> <span class="toc-page">6</span></li>
                            <li class="toc-item"><span>Days on Market Until Sale</span> <span class="toc-page">7</span></li>
                            <li class="toc-item"><span>Median Sales Price</span> <span class="toc-page">8</span></li>
                            <li class="toc-item"><span>Percent of List Price Received</span> <span class="toc-page">9</span></li>
                            <li class="toc-item"><span>Inventory of Homes for Sale</span> <span class="toc-page">10</span></li>
                            <li class="toc-item"><span>Months Supply of Inventory</span> <span class="toc-page">11</span></li>
                            <li class="toc-item"><span>Bonita Springs-Estero</span> <span class="toc-page">12</span></li>
                        </ul>
                    </div>
                </div>

                <div style="position: absolute; bottom: 30px; right: 40px; font-size: 10px; color: #999;">
                    Current as of <span id="coverDate">${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>. All data from Bonita Springs-Estero Board of Realtors¬Æ MLS.
                </div>
            `;
            container.appendChild(page);
        }






        // Update report triggers
        function reprocessAllData() {
            // Since we now pull data on demand via getMetricValue, 
            // we just need to refresh the UI.
            if (document.getElementById('monthly-indicators-container').style.display !== 'none') {
                generateMonthlyIndicators();
            } else {
                updateReport();
            }
        }

        // Reset data to empty state (not the hardcoded defaults)


        // Set current date in footer
        function setCurrentDate() {
            const now = new Date();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const day = now.getDate();
            const month = monthNames[now.getMonth()];
            const year = now.getFullYear();

            // Add ordinal suffix (1st, 2nd, 3rd, etc.)
            const suffix = (day === 1 || day === 21 || day === 31) ? 'st' :
                (day === 2 || day === 22) ? 'nd' :
                    (day === 3 || day === 23) ? 'rd' : 'th';

            document.getElementById('currentDate').textContent = month + ' ' + day + suffix + ', ' + year;
        }

        // Initialize
        setCurrentDate();

        // === MONTHLY INDICATORS HELPERS & RENDERERS ===

        // Global helper to get metric value


        // Redefined calculateQuickFacts using global helper
        function calculateQuickFacts() {
            try {
                const year = parseInt(document.getElementById('selectYear').value);
                const monthName = document.getElementById('selectMonth').value;
                const monthIdx = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"].indexOf(monthName) + 1;
                const prevYear = year - 1;

                const totalClosedCurr = getMetricValue('all', 'closedSales', monthIdx, year);
                const totalClosedPrev = getMetricValue('all', 'closedSales', monthIdx, prevYear);
                const changeClosed = totalClosedPrev ? ((totalClosedCurr - totalClosedPrev) / totalClosedPrev) * 100 : 0;

                const medianCurr = getMetricValue('all', 'medianPrice', monthIdx, year);
                const medianPrev = getMetricValue('all', 'medianPrice', monthIdx, prevYear);
                const changeMedian = medianPrev ? ((medianCurr - medianPrev) / medianPrev) * 100 : 0;

                const invCurr = getMetricValue('all', 'inventory', monthIdx, year);
                const invPrev = getMetricValue('all', 'inventory', monthIdx, prevYear);
                const changeInv = invPrev ? ((invCurr - invPrev) / invPrev) * 100 : 0;

                const formatPct = (val) => {
                    const s = val.toFixed(2) + '%';
                    return val > 0 ? '+' + s : s;
                };

                return {
                    closedSales: formatPct(changeClosed),
                    medianPrice: formatPct(changeMedian),
                    activeListings: formatPct(changeInv)
                };
            } catch (e) {
                return { closedSales: 'N/A', medianPrice: 'N/A', activeListings: 'N/A' };
            }
        }

        function renderOverviewPage(container, propType, pageNum) {
            const monthName = document.getElementById('month').value;
            const year = parseInt(document.getElementById('year').value);
            const monthIdx = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"].indexOf(monthName) + 1;
            const prevYear = year - 1;

            let title = "";
            let subTitle = "Key metrics by report month and for year-to-date (YTD) starting from the first of the year.";
            if (propType === 'singleFamily') {
                title = "Single Family Market Overview";
                subTitle += " Single Family properties only.";
            } else if (propType === 'condo') {
                title = "Condo Market Overview";
                subTitle += " Condo properties only.";
            } else {
                title = "Southwest Florida (Lee, Collier, Hendry)";
                subTitle += " PropertyTypes: Single Family, Condo, Townhome & Multi-Family.";
            }

            const page = document.createElement('div');
            page.className = 'indicator-page';
            page.innerHTML = `
                <div class="cover-header" style="border:none; margin-bottom: 10px;">
                    <div class="cover-title" style="font-size: 28px;">${title}</div>
                    <img src="https://bonitaesterorealtors.com/wp-content/uploads/2025/12/Ber-logo-2026-scaled.png" style="width: 150px;">
                </div>
                <div style="font-size: 11px; color: #666; margin-bottom: 20px;">${subTitle}</div>

                <div class="overview-table-container">
                    <table class="data-table" style="font-size: 9pt;">
                        <thead>
                            <tr>
                                <th style="text-align:left; background: var(--primary); color: white;">Key Metrics</th>
                                <th style="background: var(--primary); color: white; width: 200px;">Historical Graph</th>
                                <th style="background: var(--primary); color: white;">${monthIdx}-${prevYear}</th>
                                <th style="background: var(--primary); color: white;">${monthIdx}-${year}</th>
                                <th style="background: var(--primary); color: white;">% Change</th>
                                <th style="background: var(--primary); color: white;">YTD ${prevYear}</th>
                                <th style="background: var(--primary); color: white;">YTD ${year}</th>
                                <th style="background: var(--primary); color: white;">% Change</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${metrics.filter(m => m.key !== 'soldVolume').map((m, i) => {
                const mCurr = getMetricValue(propType, m.key, monthIdx, year);
                const mPrev = getMetricValue(propType, m.key, monthIdx, prevYear);
                const mChange = mPrev ? ((mCurr - mPrev) / mPrev) * 100 : 0;

                let ytdCurr = 0, ytdPrev = 0;
                if (m.hasYtd) {
                    for (let k = 1; k <= monthIdx; k++) {
                        ytdCurr += getMetricValue(propType, m.key, k, year);
                        ytdPrev += getMetricValue(propType, m.key, k, prevYear);
                    }
                    if (m.key === 'daysOnMarket' || m.key === 'medianPrice' || m.key === 'listPriceReceived' || m.key === 'monthsSupply') {
                        ytdCurr /= monthIdx;
                        ytdPrev /= monthIdx;
                    }
                }

                const ytdChange = ytdPrev ? ((ytdCurr - ytdPrev) / ytdPrev) * 100 : 0;
                const fmt = (val) => {
                    if (m.format === 'currency') return '$' + Math.round(val).toLocaleString();
                    if (m.format === 'percent') return val.toFixed(1) + '%';
                    return Math.round(val).toLocaleString();
                };
                const fmtPct = (val) => (val > 0 ? '+' : '') + val.toFixed(1) + '%';
                const canvasId = `spark-${propType}-${i}`;

                return `<tr>
                                    <td style="text-align:left;">${m.label}</td>
                                    <td style="padding: 2px;"><canvas id="${canvasId}" style="width:190px; height:50px;"></canvas></td>
                                    <td>${fmt(mPrev)}</td>
                                    <td>${fmt(mCurr)}</td>
                                    <td>${fmtPct(mChange)}</td>
                                    <td>${m.hasYtd ? fmt(ytdPrev) : ''}</td>
                                    <td>${m.hasYtd ? fmt(ytdCurr) : ''}</td>
                                    <td>${m.hasYtd ? fmtPct(ytdChange) : ''}</td>
                                </tr>`;
            }).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="position: absolute; bottom: 30px; right: 40px; font-size: 10px; color: #999;">
                    Current as of <span id="coverDate">${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>. All data from Bonita Springs-Estero Board of Realtors¬Æ MLS.
                </div>
                <div style="position: absolute; bottom: 30px; right: 20px; font-size: 14px; font-weight: bold; color: #00A6CE;">${pageNum}</div>
            `;
            container.appendChild(page);

            metrics.filter(m => m.key !== 'soldVolume').forEach((m, i) => {
                const cvs = document.getElementById(`spark-${propType}-${i}`);
                if (!cvs) return;
                const ctx = cvs.getContext('2d');
                const history = [];
                for (let k = 0; k < 24; k++) {
                    let y = year;
                    let mo = monthIdx - k;
                    while (mo <= 0) { mo += 12; y--; }
                    history.unshift(getMetricValue(propType, m.key, mo, y));
                }
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array(24).fill(''),
                        datasets: [{
                            data: history,
                            borderColor: '#0ea5e9',
                            borderWidth: 2,
                            pointRadius: (ctx) => {
                                const idx = ctx.dataIndex;
                                return (idx === 11 || idx === 23) ? 4 : 0;
                            },
                            pointBackgroundColor: '#ffb700',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            fill: false,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { enabled: false } },
                        scales: { x: { display: false }, y: { display: false, min: 0 } },
                        animation: false
                    }
                });
            });
        }
        function renderMetricPage(container, metricKey, pageNum) {
            const year = parseInt(document.getElementById('year').value);
            const monthName = document.getElementById('month').value;
            const monthIdx = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"].indexOf(monthName) + 1;

            const metricObj = metrics.find(m => m.key === metricKey);
            const title = metricObj ? metricObj.label : metricKey;

            // Subtitle mapping
            const subtitles = {
                'newListings': 'A count of the properties that have been newly listed on the market in a given month.',
                'pendingSales': 'A count of the properties on which offers have been accepted in a given month.',
                'closedSales': 'A count of the actual sales that closed in a given month.',
                'daysOnMarket': 'Average number of days between when a property is listed and when an offer is accepted in a given month.',
                'medianPrice': 'Point at which half of the sales sold for more and half sold for less, not accounting for seller concessions, in a given month.',
                'listPriceReceived': 'Percentage found when dividing a property\'s sales price by its most recent list price, then taking the average for all properties sold in a given month, not accounting for seller concessions.',
                'inventory': 'The number of properties available for sale in active status at the end of a given month.',
                'monthsSupply': 'The inventory of homes for sale at the end of a given month, divided by the average monthly pending sales from the last 12 months.'
            };
            const desc = subtitles[metricKey] || "";

            const page = document.createElement('div');
            page.className = 'indicator-page';
            page.innerHTML = `
                <div class="cover-header" style="border:none; margin-bottom: 5px;">
                    <div class="cover-title" style="font-size: 32px;">${title}</div>
                    <img src="https://bonitaesterorealtors.com/wp-content/uploads/2025/12/Ber-logo-2026-scaled.png" style="width: 150px;">
                </div>
                <div style="font-size: 11px; color: #666; margin-bottom: 30px; font-style: italic;">${desc}</div>

                <!-- Three Columns: Monthly Bar, YTD Bar, Map -->
                <!-- Two Columns: Monthly Bar, YTD Bar (Map removed) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 20px; height: 280px;">
                    <div>
                        <div style="font-weight:bold; margin-bottom: 5px;">${monthName}</div>
                        <canvas id="chart-month-${metricKey}" style="width:100%; height:260px;"></canvas>
                    </div>
                    <div>
                        <div style="font-weight:bold; margin-bottom: 5px;">Year to Date</div>
                        <canvas id="chart-ytd-${metricKey}" style="width:100%; height:260px;"></canvas>
                    </div>
                </div>

                <!-- Historical Line Chart -->
                <div>
                     <div style="font-weight:bold; margin-bottom: 5px; margin-top: 20px;">${title} by Month</div>
                     <canvas id="chart-hist-${metricKey}" style="width:100%; height:350px;"></canvas>
                </div>

                <div style="position: absolute; bottom: 30px; right: 40px; font-size: 10px; color: #999;">
                    Current as of <span id="coverDate">${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>. All data from Bonita Springs-Estero Board of Realtors¬Æ MLS.
                </div>
                <div style="position: absolute; bottom: 30px; right: 20px; font-size: 14px; font-weight: bold; color: #00A6CE;">${pageNum}</div>
            `;
            container.appendChild(page);

            // --- Charts ---
            const ctxMonth = document.getElementById(`chart-month-${metricKey}`).getContext('2d');
            const ctxYtd = document.getElementById(`chart-ytd-${metricKey}`).getContext('2d');
            const ctxHist = document.getElementById(`chart-hist-${metricKey}`).getContext('2d');

            const years = [year - 2, year - 1, year];

            // Data for Bar Charts
            // SF: [Val(y-2), Val(y-1), Val(y)]
            const sfMonthData = years.map(y => getMetricValue('singleFamily', metricKey, monthIdx, y));
            const condoMonthData = years.map(y => getMetricValue('condo', metricKey, monthIdx, y));

            // YTD Data
            // We need helper for YTD aggregation if not already present in getMetricValue (getMetricValue is monthly)
            // We'll just loop nicely.
            const getYtd = (prop, y) => {
                let sum = 0; let count = 0;
                for (let k = 1; k <= monthIdx; k++) {
                    const val = getMetricValue(prop, metricKey, k, y);
                    if (val) { sum += val; count++; }
                }
                if (metricKey === 'daysOnMarket' || metricKey === 'medianPrice' || metricKey === 'listPriceReceived' || metricKey === 'monthsSupply') {
                    return count ? sum / count : 0;
                }
                return sum;
            };

            const sfYtdData = years.map(y => getYtd('singleFamily', y));
            const condoYtdData = years.map(y => getYtd('condo', y));

            const barOptions = {
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { font: { size: 10 } } },
                    y: { ticks: { font: { size: 10 } } }
                },
                maintainAspectRatio: false
            };

            // Month and YTD charts are Grouped Bars: Labels: Years? No, Labels: Categories (SF, Condo). Bars: Years.
            // Screenshot shows specific grouping.
            // Actually, screenshot 4 shows: Labels on bottom are "Single Family" and "Condo". And within each, 3 bars for years.

            const barConfig = (dataSF, dataCondo) => ({
                type: 'bar',
                data: {
                    labels: ['Single Family', 'Condo'],
                    datasets: [
                        { label: (year - 2).toString(), data: [dataSF[0], dataCondo[0]], backgroundColor: '#4dc9e6' },
                        { label: (year - 1).toString(), data: [dataSF[1], dataCondo[1]], backgroundColor: '#00a6ce' },
                        { label: year.toString(), data: [dataSF[2], dataCondo[2]], backgroundColor: '#006b85' }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            new Chart(ctxMonth, barConfig(sfMonthData, condoMonthData));
            new Chart(ctxYtd, barConfig(sfYtdData, condoYtdData));

            // Historical Line Chart
            // 5 Years history? Or since 2017? Screenshot shows 2017-Jan start.
            // Let's generate data from 2017-01 to Today.
            const histLabels = [];
            const histSF = [];
            const histCondo = [];

            // Loop from 2017 to current year
            for (let y = 2017; y <= year; y++) {
                const endM = (y === year) ? monthIdx : 12;
                for (let m = 1; m <= endM; m++) {
                    histLabels.push(`${y}-${m}`);
                    histSF.push(getMetricValue('singleFamily', metricKey, m, y));
                    histCondo.push(getMetricValue('condo', metricKey, m, y));
                }
            }

            new Chart(ctxHist, {
                type: 'line',
                data: {
                    labels: histLabels,
                    datasets: [
                        { label: 'Single Family', data: histSF, borderColor: '#ca8a04', borderWidth: 2, pointRadius: 0, tension: 0.1 },
                        { label: 'Condo', data: histCondo, borderColor: '#4dc9e6', borderWidth: 2, pointRadius: 0, tension: 0.1 }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        x: {
                            ticks: {
                                maxTicksLimit: 12,
                                callback: function (val, index) {
                                    // Custom tick formatting if needed
                                    const label = this.getLabelForValue(val);
                                    return label.split('-')[0]; // Show Year
                                }
                            }
                        },
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderMetricPage(container, metricKey, pageNum) {
            const year = parseInt(document.getElementById('year').value);
            const monthName = document.getElementById('month').value;
            const monthIdx = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"].indexOf(monthName) + 1;

            const metricObj = metrics.find(m => m.key === metricKey);
            const title = metricObj ? metricObj.label : metricKey;

            // Subtitle mapping
            const subtitles = {
                'newListings': 'A count of the properties that have been newly listed on the market in a given month.',
                'pendingSales': 'A count of the properties on which offers have been accepted in a given month.',
                'closedSales': 'A count of the actual sales that closed in a given month.',
                'daysOnMarket': 'Average number of days between when a property is listed and when an offer is accepted in a given month.',
                'medianPrice': 'Point at which half of the sales sold for more and half sold for less, not accounting for seller concessions, in a given month.',
                'listPriceReceived': 'Percentage found when dividing a property\'s sales price by its most recent list price, then taking the average for all properties sold in a given month, not accounting for seller concessions.',
                'inventory': 'The number of properties available for sale in active status at the end of a given month.',
                'monthsSupply': 'The inventory of homes for sale at the end of a given month, divided by the average monthly pending sales from the last 12 months.'
            };
            const desc = subtitles[metricKey] || "";

            const page = document.createElement('div');
            page.className = 'indicator-page';
            page.innerHTML = `
                <div class="cover-header" style="border:none; margin-bottom: 5px;">
                    <div class="cover-title" style="font-size: 32px;">${title}</div>
                    <img src="https://bonitaesterorealtors.com/wp-content/uploads/2025/12/Ber-logo-2026-scaled.png" style="width: 150px;">
                </div>
                <div style="font-size: 11px; color: #666; margin-bottom: 30px; font-style: italic;">${desc}</div>

                <!-- Three Columns: Monthly Bar, YTD Bar, Map -->
                <!-- Three Columns: Monthly Bar, YTD Bar, Map -->
                <!-- Three Columns: Monthly Bar, YTD Bar, Map -->
                <div style="display: grid; grid-template-columns: 1.5fr 1.5fr 180px; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <div style="font-weight:bold; margin-bottom: 5px;">${monthName}</div>
                        <div style="position: relative; height: 280px; width: 100%;">
                            <canvas id="chart-month-${metricKey}"></canvas>
                        </div>
                    </div>
                    <div>
                        <div style="font-weight:bold; margin-bottom: 5px;">Year to Date</div>
                        <div style="position: relative; height: 280px; width: 100%;">
                            <canvas id="chart-ytd-${metricKey}"></canvas>
                        </div>
                    </div>
                    <div>
                         <?xml version="1.0" encoding="utf-8"?><!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"	 width="150px" height="150px" viewBox="0 0 150 150" enable-background="new 0 0 150 150" xml:space="preserve"><rect x="10" y="10" fill="#E6E6E6" width="130" height="130"/><text transform="matrix(1 0 0 1 35 75)" fill="#666666" font-family="'ArialMT'" font-size="12">Map Placeholder</text></svg>
                    </div>
                </div>

                <!-- Historical Line Chart -->
                <div>
                     <div style="font-weight:bold; margin-bottom: 5px; margin-top: 20px;">${title} by Month</div>
                     <div style="position: relative; height: 350px; width: 100%;">
                        <canvas id="chart-hist-${metricKey}"></canvas>
                     </div>
                </div>

                <div style="position: absolute; bottom: 30px; right: 40px; font-size: 10px; color: #999;">
                    Current as of <span id="coverDate">${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>. All data from Bonita Springs-Estero Board of Realtors¬Æ MLS.
                </div>
                <div style="position: absolute; bottom: 30px; right: 20px; font-size: 14px; font-weight: bold; color: #00A6CE;">${pageNum}</div>
            `;
            container.appendChild(page);

            // --- Charts ---
            const ctxMonth = document.getElementById(`chart-month-${metricKey}`).getContext('2d');
            const ctxYtd = document.getElementById(`chart-ytd-${metricKey}`).getContext('2d');
            const ctxHist = document.getElementById(`chart-hist-${metricKey}`).getContext('2d');

            const years = [year - 2, year - 1, year];

            // Monthly Data
            const sfMonthData = years.map(y => getMetricValue('singleFamily', metricKey, monthIdx, y));
            const condoMonthData = years.map(y => getMetricValue('condo', metricKey, monthIdx, y));
            const landMonthData = years.map(y => getMetricValue('land', metricKey, monthIdx, y));
            const multiMonthData = years.map(y => getMetricValue('multiFamily', metricKey, monthIdx, y));

            // YTD Data logic
            const getYtd = (prop, y) => {
                let sum = 0; let count = 0;
                for (let k = 1; k <= monthIdx; k++) {
                    const val = getMetricValue(prop, metricKey, k, y);
                    if (val) { sum += val; count++; }
                }
                if (metricKey === 'daysOnMarket' || metricKey === 'medianPrice' || metricKey === 'listPriceReceived' || metricKey === 'monthsSupply') {
                    return count ? sum / count : 0;
                }
                return sum;
            };

            const sfYtdData = years.map(y => getYtd('singleFamily', y));
            const condoYtdData = years.map(y => getYtd('condo', y));
            const landYtdData = years.map(y => getYtd('land', y));
            const multiYtdData = years.map(y => getYtd('multiFamily', y));

            // Config for Grouped Bars
            const barConfig = (dataSF, dataCondo, dataLand, dataMulti) => ({
                type: 'bar',
                data: {
                    labels: ['Single Family', 'Condo', 'Land', 'Multi-Family'],
                    datasets: [
                        { label: (year - 2).toString(), data: [dataSF[0], dataCondo[0], dataLand[0], dataMulti[0]], backgroundColor: '#4dc9e6' },
                        { label: (year - 1).toString(), data: [dataSF[1], dataCondo[1], dataLand[1], dataMulti[1]], backgroundColor: '#00a6ce' },
                        { label: year.toString(), data: [dataSF[2], dataCondo[2], dataLand[2], dataMulti[2]], backgroundColor: '#006b85' }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            new Chart(ctxMonth, barConfig(sfMonthData, condoMonthData, landMonthData, multiMonthData));
            new Chart(ctxYtd, barConfig(sfYtdData, condoYtdData, landYtdData, multiYtdData));

            // Historical Line Chart
            const histLabels = [];
            const histSF = [];
            const histCondo = [];
            const histLand = [];
            const histMulti = [];

            for (let y = 2017; y <= year; y++) {
                const endM = (y === year) ? monthIdx : 12;
                for (let m = 1; m <= endM; m++) {
                    histLabels.push(`${y}-${m}`);
                    histSF.push(getMetricValue('singleFamily', metricKey, m, y));
                    histCondo.push(getMetricValue('condo', metricKey, m, y));
                    histLand.push(getMetricValue('land', metricKey, m, y));
                    histMulti.push(getMetricValue('multiFamily', metricKey, m, y));
                }
            }

            // Trim leading zeros
            let startIndex = 0;
            for (let i = 0; i < histLabels.length; i++) {
                if (histSF[i] > 0 || histCondo[i] > 0 || histLand[i] > 0 || histMulti[i] > 0) {
                    startIndex = i;
                    break;
                }
            }
            if (startIndex > 0) {
                histLabels.splice(0, startIndex);
                histSF.splice(0, startIndex);
                histCondo.splice(0, startIndex);
                histLand.splice(0, startIndex);
                histMulti.splice(0, startIndex);
            }

            new Chart(ctxHist, {
                type: 'line',
                data: {
                    labels: histLabels,
                    datasets: [
                        { label: 'Single Family', data: histSF, borderColor: '#ca8a04', borderWidth: 2, pointRadius: 0, tension: 0.1 },
                        { label: 'Condo', data: histCondo, borderColor: '#4dc9e6', borderWidth: 2, pointRadius: 0, tension: 0.1 },
                        { label: 'Land', data: histLand, borderColor: '#16a34a', borderWidth: 2, pointRadius: 0, tension: 0.1 },
                        { label: 'Multi-Family', data: histMulti, borderColor: '#9333ea', borderWidth: 2, pointRadius: 0, tension: 0.1 }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        x: {
                            ticks: {
                                maxTicksLimit: 12,
                                callback: function (val, index) {
                                    const label = this.getLabelForValue(val);
                                    return label.split('-')[0];
                                }
                            }
                        },
                        y: { beginAtZero: true }
                    }
                }
            });
        }


        async function downloadPDF(type, btn) {
            const originalText = btn.innerText;
            btn.innerText = 'Initializing...';

            if (!window.jspdf || !window.html2canvas) {
                alert('PDF Libraries not loaded. Please refresh.');
                btn.innerText = originalText;
                return;
            }

            const { jsPDF } = window.jspdf;
            const isLandscape = (type === 'monthly');
            const orientation = isLandscape ? 'l' : 'p';
            const format = 'letter'; // 8.5in x 11in

            // Create PDF
            const doc = new jsPDF({ unit: 'in', format: format, orientation: orientation });

            // Select Pages
            let pages = [];
            if (isLandscape) {
                pages = Array.from(document.querySelectorAll('#monthly-indicators-container .indicator-page'));
            } else {
                const el = document.querySelector('.fast-stats-layout');
                if (el) pages.push(el);
            }

            if (pages.length === 0) {
                alert('No pages found to generate.');
                btn.innerText = originalText;
                return;
            }

            // Loop and Render
            try {
                for (let i = 0; i < pages.length; i++) {
                    btn.innerText = `Processing Page ${i + 1}/${pages.length}...`;

                    // Add new page if not the first
                    if (i > 0) doc.addPage(format, orientation);

                    // Render with High Scale (2 is good, 3 is print quality)
                    // We can use 2 to be safe on memory, but user asked for higher resolution. 
                    // Since we render ONE page at a time, we can handle scale 2 easy.
                    const canvas = await html2canvas(pages[i], {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        windowWidth: isLandscape ? 1100 : 850
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const pdfW = isLandscape ? 11 : 8.5;
                    const pdfH = isLandscape ? 8.5 : 11;

                    doc.addImage(imgData, 'JPEG', 0, 0, pdfW, pdfH);
                }

                btn.innerText = 'Saving...';
                doc.save(`BER_${type === 'monthly' ? 'Monthly_Indicators' : 'Fast_Stats'}.pdf`);
            } catch (e) {
                console.error('PDF Generation Error:', e);
                alert('Error generating PDF. See console.');
            } finally {
                btn.innerText = originalText;
            }
        }



        updateReport();
    </script>
</body>

</html>